@page "/customers"
@using Kuyumcu.Components.Helper
@inject DatabaseService DatabaseService
@inject NavigationManager NavigationManager
@inject IDialogService Dialog


<MudContainer Class="mt-4">
    <MudPaper Elevation="0" Class="mb-4">
        <MudGrid>
            <MudItem xs="12">
                <MudText Typo="Typo.h4">Müşteriler</MudText>
            </MudItem>
        </MudGrid>
    </MudPaper>

    <MudPaper Elevation="1" Class="pa-4 mb-4">
        <MudGrid>
            <MudItem xs="12" sm="6">
                <MudTextField T="string" Label="Müşteri ara..." Variant="Variant.Outlined" Adornment="Adornment.Start"
                AdornmentIcon="@Icons.Material.Filled.Search" @bind-Value="searchTerm"
                Immediate="true" OnKeyUp="@(() => Search())" />
            </MudItem>
            <MudItem xs="12" sm="6" Class="d-flex justify-end">
                <MudStack Row="true" Spacing="2">
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add"
                    OnClick="@(() => ShowCustomerModal(new Customer()))">
                        Yeni Müşteri
                    </MudButton>
                    <MudButton Variant="Variant.Outlined" Color="Color.Secondary" StartIcon="@Icons.Material.Filled.ArrowBack"
                    OnClick="GoBack">
                        Ana Sayfa
                    </MudButton>
                </MudStack>
            </MudItem>
        </MudGrid>
    </MudPaper>

    @if (isLoading)
    {
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" Class="my-7" Size="Size.Large" />
    }
    else if (customers == null || customers.Count == 0)
    {
        <MudAlert Severity="Severity.Info" Class="ma-4">Henüz müşteri kaydı bulunmamaktadır.</MudAlert>
    }
    else
    {
        <MudTable T="Customer" ServerData="@ServerReload"
        Dense="true" Hover="true" Breakpoint="Breakpoint.Sm" Loading="@isLoading" 
        OnRowClick="RowClickEvent" LoadingProgressColor="Color.Primary" 
        Elevation="0" @ref="table">
            <HeaderContent>
                <MudTh><MudTableSortLabel SortLabel="name" T="Customer">İsim</MudTableSortLabel></MudTh>
                <MudTh><MudTableSortLabel SortLabel="phone" T="Customer">Telefon</MudTableSortLabel></MudTh>
                <MudTh>İşlemler</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="İsim">@context.Name</MudTd>
                <MudTd DataLabel="Telefon">@context.PhoneNumber.FormatPhoneNumber()</MudTd>
                <MudTd DataLabel="İşlemler">
                    <MudStack Row="true">
                        <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Primary" Size="Size.Small"
                        OnClick="@(() => ShowCustomerModal(context))" />
                        <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small"
                        OnClick="@(() => DeleteCustomer(context))" />
                    </MudStack>
                </MudTd>
            </RowTemplate>
            <PagerContent>
                    <MudTablePager RowsPerPageString="Sayfa başına:" InfoFormat="{first_item}-{last_item} / {all_items}" PageSizeOptions="new int[] {10, 25, 50, 100}" />
            </PagerContent>
        </MudTable>
    }
    </MudContainer>

    <MudDialog @bind-Visible="showCustomerModal">
        <DialogContent>
            <MudContainer Style="max-height: 500px; overflow-y: auto">
                <MudText Typo="Typo.h6" Class="mb-4">@(currentCustomer.Id == 0 ? "Yeni Müşteri" : "Müşteri Düzenle")</MudText>
                <EditForm Model="@currentCustomer" OnValidSubmit="SaveCustomer">
                    <DataAnnotationsValidator />
                    <MudGrid>
                        <MudItem xs="12">
                            <MudTextField @bind-Value="currentCustomer.Name" Label="Müşteri Adı" AutoFocus Variant="Variant.Outlined"
                            Required="true" RequiredError="Müşteri adı gereklidir" />
                            <ValidationMessage For="@(() => currentCustomer.Name)" />
                        </MudItem>
                        <MudItem xs="12">
                            <input type="text" autocomplete="off" class="form-control" @bind-value="currentCustomer.PhoneNumber"></input>
                           @*  <MudTextField @bind-Value="currentCustomer.PhoneNumber" Mask=@mask2 Label="Telefon" 
                            Variant="Variant.Outlined" Immediate MaxLength="10" /> *@
                            <ValidationMessage For="@(() => currentCustomer.PhoneNumber)" />
                        </MudItem>
                    </MudGrid>
                    <MudDivider Class="my-4" />
                    <MudStack Row="true" Justify="Justify.FlexEnd">
                        <MudButton Variant="Variant.Text" Color="Color.Default" OnClick="CloseCustomerModal">İptal</MudButton>
                        <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Primary">Kaydet</MudButton>
                    </MudStack>
                </EditForm>
            </MudContainer>
        </DialogContent>
    </MudDialog>

    @code {
    private List<Customer> customers;
    private List<Customer> filteredCustomers;
    private bool isLoading = true;
    private string searchTerm = "";
    private MudTable<Customer> table;
    private PatternMask mask2 = new PatternMask("XXX-XXX-XX-XX")
        {
            MaskChars = new[] { new MaskChar('X', @"[0-9]") },
            Placeholder = '_',
            CleanDelimiters = true,
        };
    private bool showCustomerModal;
    private Customer currentCustomer = new Customer();

    protected override async Task OnInitializedAsync()
    {
        await LoadCustomers();
    }

    private void GoBack()
    {
        NavigationManager.NavigateTo("/");
    }

    private async Task LoadCustomers()
    {
        isLoading = true;
        customers = await DatabaseService.GetCustomersAsync();
        filteredCustomers = customers;
        isLoading = false;
    }

 
    private async Task<TableData<Customer>> ServerReload(TableState state, CancellationToken cancellationToken)
    {
        try
        {

            var customers = await DatabaseService.GetCustomersPaginationAsync(state.Page, state.PageSize, state?.SortLabel, Helper.HelperMethods.GetSortDirection(state?.SortDirection), searchTerm);
            int totalItems = await DatabaseService.GetCustomerCountAsync(searchTerm);

            return new TableData<Customer>
            {
                Items = customers,
                TotalItems = totalItems
            };
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex);
            // Handle errors
            return new TableData<Customer>
            {
                Items = new List<Customer>(),
                TotalItems = 0
            };
        }
    }

    private async Task OnSearch(string text)
    {
        searchTerm = text;
        await table.ReloadServerData();
    }

    private void Search()
    {
        // Legacy method, replaced by server-side filtering
        // Keep for compatibility
        table?.ReloadServerData();
    }

    private void ShowCustomerModal(Customer customer)
    {
        currentCustomer = new Customer
            {
                Id = customer.Id,
                Name = customer.Name,
                PhoneNumber = customer.PhoneNumber
            };
        showCustomerModal = true;
    }

    private void CloseCustomerModal()
    {
        showCustomerModal = false;
    }

    private async Task SaveCustomer()
    {
        // Yeni müşteri ekliyorsak aynı isimde başka müşteri var mı kontrol et
        if (currentCustomer.Id == 0 && !string.IsNullOrWhiteSpace(currentCustomer.Name))
        {
            var existingCustomer = await DatabaseService.GetCustomerByNameAsync(currentCustomer.Name);
            if (existingCustomer != null)
            {
                // Varolan müşteri bulundu, uyarı göster
                bool? result = await Dialog.ShowMessageBox(
                    "Aynı İsimde Müşteri Bulundu",
                    $"\"{currentCustomer.Name}\" adında bir müşteri zaten var. Ne yapmak istersiniz?",
                    yesText: "Varolan Müşteriye Git",
                    noText: "Yine de Kaydet",
                    cancelText: "İptal");

                if (result == true) // Varolan müşteriye git
                {
                    CloseCustomerModal();
                    NavigationManager.NavigateTo($"/customer/{existingCustomer.Id}");
                    return;
                }
                else if (result == null) // İptal
                {
                    return;
                }
                // Else: Yine de kaydet - devam et
            }
        }

        await DatabaseService.SaveCustomerAsync(currentCustomer);
        CloseCustomerModal();
        // await table.ReloadServerData();
        NavigationManager.NavigateTo($"/customer/{currentCustomer.Id}");
    }

    private async Task DeleteCustomer(Customer customer)
    {
        // var transactions = await DatabaseService.GetCustomerTransactionsAsync(customer.Id);
        // if (transactions.Count > 0)
        // {
        //     // TODO: Show error message
        //     return;
        // }
        var confirmResult = await Dialog.ShowMessageBox(
           "Emin misiniz?",
           $"{customer.Name} sistemden silinecek",
           yesText: "Evet",
           noText: "Hayır");

        if (confirmResult == true)
        {
            await DatabaseService.DeleteCustomerAsync(customer);
            await table.ReloadServerData();
        }
    }

    private void ViewCustomerTransactions(Customer customer)
    {
        NavigationManager.NavigateTo($"/customer/{customer.Id}");
    }
    private void RowClickEvent(TableRowClickEventArgs<Customer> customer)
    {
        if (customer?.Item != null)
            NavigationManager.NavigateTo($"/customer/{customer.Item.Id}");

    }
}
