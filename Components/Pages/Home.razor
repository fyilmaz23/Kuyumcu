@page "/"
@page "/home"
@using Kuyumcu.Components.Helper
@using Kuyumcu.Models
@using Kuyumcu.Services
@inject DatabaseService DatabaseService
@inject NavigationManager NavigationManager
@inject IDialogService DialogService
@inject IJSRuntime JSRuntime
@inject GoogleDriveService GoogleDriveService
@inject GoldPriceExportService GoldPriceExportService

<MudContainer Class="mt-4">
    <!-- Dashboard İçeriği -->
    <MudGrid>
        <!-- Özet Bilgiler -->
        <MudItem xs="12">
            <MudGrid>
                <MudItem xs="12" sm="6" md="3">
                    <MudPaper Elevation="2" Class="pa-4 mud-theme-primary" Style="height: 100%;">
                        <MudStack>
                            <MudText Typo="Typo.subtitle1">Toplam Müşteri</MudText>
                            <MudText Typo="Typo.h4">@totalCustomerCount</MudText>
                            <MudIcon Icon="@Icons.Material.Filled.People" Size="Size.Large" />
                        </MudStack>
                    </MudPaper>
                </MudItem>
                <MudItem xs="12" sm="6" md="3">
                    <MudPaper Elevation="2" Class="pa-4 mud-theme-secondary" Style="height: 100%;">
                        <MudStack>
                            <MudText Typo="Typo.subtitle1">Borçlu Müşteri Sayısı</MudText>
                            <MudText Typo="Typo.h4">@indebtedCustomersCount</MudText>
                            <MudIcon Icon="@Icons.Material.Filled.AccountBalance" Size="Size.Large" />
                        </MudStack>
                    </MudPaper>
                </MudItem>
                <MudItem xs="12" sm="6" md="3">
                    <MudPaper Elevation="2" Class="pa-4 mud-theme-tertiary" Style="height: 100%;">
                        <MudStack>
                            <MudText Typo="Typo.subtitle1">Bu Ayki İşlem Sayısı</MudText>
                            <MudText Typo="Typo.h4">@currentMonthTransactionCount</MudText>
                            <MudIcon Icon="@Icons.Material.Filled.DateRange" Size="Size.Large" />
                        </MudStack>
                    </MudPaper>
                </MudItem>
                <MudItem xs="12" sm="6" md="3">
                    <MudPaper Elevation="2" Class="pa-4 mud-theme-info" Style="height: 100%;">
                        <MudStack>
                            <MudText Typo="Typo.subtitle1">En Hareketli İşlem Türü</MudText>
                            <MudText Typo="Typo.h4">@mostActiveCurrencyName  <MudText Typo="Typo.caption">@mostActiveCurrencyCount işlem</MudText></MudText>
                            <MudIcon Icon="@Icons.Material.Filled.ShowChart" Size="Size.Large" />
                        </MudStack>
                    </MudPaper>
                </MudItem>
            </MudGrid>
        </MudItem>

        <!-- Para Birimine Göre İşlemler -->
        <MudItem xs="12" md="8">
            <MudPaper Elevation="2" Class="pa-4">
                <MudText Typo="Typo.h6" Class="mb-4">Para Birimine Göre En Sık İşlemler</MudText>
                <MudChart ChartType="ChartType.Pie" InputData="@currencyDistributionData" ChartOptions="_axisChartOptions" InputLabels="@currencyLabels" Width="100%" Height="300px" />
            </MudPaper>
        </MudItem>

        <!-- En Aktif Müşteriler -->
        <MudItem xs="12" md="4">
            <MudPaper Elevation="2" Class="pa-4" Style="height: 100%;">
                <MudText Typo="Typo.h6" Class="mb-4">En Aktif Müşteriler</MudText>
                @if (topCustomers.Any())
                {
                    <MudList T="string" Dense="true">
                        @foreach (var customer in topCustomers)
                        {
                            <MudListItem Icon="@Icons.Material.Filled.Person" IconColor="Color.Primary" @onclick="() => NavigateToCustomerDetail(customer.CustomerId)">
                                <div class="d-flex justify-space-between align-center w-100">
                                    <span>@customer.CustomerName</span>
                                    <MudChip T="string" Color="@Color.Info" Size="@Size.Small">@customer.TransactionCount işlem</MudChip>
                                </div>
                            </MudListItem>
                        }
                    </MudList>
                }
                else
                {
                    <MudText>Henüz işlem yapılmamış.</MudText>
                }
            </MudPaper>
        </MudItem>

        <!-- Aylara Göre İşlemler -->
        <MudItem xs="12">
            <MudPaper Elevation="2" Class="pa-4">
                <MudText Typo="Typo.h6" Class="mb-4">Son 6 Ay İşlem Dağılımı</MudText>
                <MudChart ChartType="ChartType.Bar" ChartSeries="@monthlyTransactionSeries" XAxisLabels="@monthLabels" Width="100%" Height="350px">
                    <CustomGraphics>
                        <style>
                            .mud-chart-serie { stroke-width: 2px; }
                        </style>
                    </CustomGraphics>
                </MudChart>
            </MudPaper>
        </MudItem>
    </MudGrid>
</MudContainer>
@code {

    private bool showCustomerModal;
    private bool isBackupInProgress = false;
    private string backupResult = string.Empty;
    private ChartOptions _axisChartOptions = new ChartOptions()
    {
ShowToolTips = true,
       
    };
    // Dashboard verileri
    private int totalCustomerCount = 0;
    private int indebtedCustomersCount = 0;
    private int currentMonthTransactionCount = 0;
    private string mostActiveCurrencyName = "";
    private int mostActiveCurrencyCount = 0;

    // Para birimine göre işlemler için pasta grafik verisi
    private double[] currencyDistributionData = Array.Empty<double>();
    private string[] currencyLabels = Array.Empty<string>();

    // Aylık işlemler için çubuk grafik verisi (son 6 ay)
    private List<ChartSeries> monthlyTransactionSeries = new();
    private string[] monthLabels = new string[6]; // Son 6 ay için etiketler

    // En aktif müşteriler listesi
    private List<CustomerActivityData> topCustomers = new();

    // Son işlemler listesi
    private List<Transaction> recentTransactions = new();

    // Müşteri isimleri cache'i
    private Dictionary<int, string> customerNames = new();

    public PatternMask mask2 = new PatternMask("XXX-XXX-XX-XX")
        {
            MaskChars = new[] { new MaskChar('X', @"[0-9]") },
            Placeholder = '_',
            CleanDelimiters = true,
        };

    // Active tab

    // QuickEntry related properties
    private List<QuickEntry> quickEntries;
    private QuickEntry currentQuickEntry = new QuickEntry();
    private bool isLoadingQuickEntries = false;

    // Customers variables
    private List<Customer> customers;
    private List<Customer> filteredCustomers;
    private string searchTerm = "";
    private bool isLoadingCustomers = false;
    private Customer currentCustomer = new Customer();
    private MudTable<Customer> customerTable;

    // Transactions variables
    private List<Transaction> transactions;
    private string transactionSearchTerm = "";
    private bool isLoadingTransactions = false;
    private MudTable<Transaction> transactionTable;
    private Dictionary<int, string> transactionCustomerNames = new Dictionary<int, string>();

    protected override async Task OnInitializedAsync()
    {
        await LoadDashboardData();
    }
    private async Task LoadDashboardData()
    {
        try
        {
            // Müşteri sayısını al
            totalCustomerCount = await DatabaseService.GetCustomerCountAsync(string.Empty);

            // İşlem ve borçlu müşteri sayısını al
            var allTransactions = await DatabaseService.GetTransactionsAsync();
            await CalculateIndebtedCustomers(allTransactions);

            // Bu ayki işlem sayısını hesapla
            var now = DateTime.Now;
            var currentMonth = new DateTime(now.Year, now.Month, 1);
            var nextMonth = currentMonth.AddMonths(1);
            currentMonthTransactionCount = allTransactions.Count(t => 
                !t.IsDeleted && !t.IsDeposit && 
                t.Date >= currentMonth && t.Date < nextMonth);

            // En hareketli işlem türünü hesapla
            var mostActiveCurrency = await DatabaseService.GetMostActiveCurrencyTypeAsync();
            mostActiveCurrencyName = mostActiveCurrency.CurrencyType.GetDisplayName();
            mostActiveCurrencyCount = mostActiveCurrency.TransactionCount;

            // Para birimine göre işlemleri hesapla
            await CalculateCurrencyDistribution(allTransactions);

            // Aylara göre işlemleri hesapla
            await CalculateMonthlyTransactions(allTransactions);

            // En aktif müşterileri hesapla
            await CalculateTopCustomers(allTransactions);

            // Son işlemleri hesapla
            recentTransactions = allTransactions
                .Where(t => !t.IsDeleted && !t.IsDeposit)
                .OrderByDescending(t => t.Date)
                .Take(10)
                .ToList();

            // Müşteri isimlerini önbelleğe al
            await CacheCustomerNames();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Dashboard verisi yüklenirken hata: {ex.Message}");
            await DialogService.ShowMessageBox("Hata", $"Dashboard verisi yüklenirken bir hata oluştu: {ex.Message}");
        }
    }

    private async Task CalculateCurrencyDistribution(IEnumerable<Transaction> transactions)
    {
        // Para birimine göre işlemleri grupla
        var currencyGroups = transactions
            .Where(t => !t.IsDeleted && !t.IsDeposit)
            .GroupBy(t => t.CurrencyType)
            .Select(g => new { CurrencyType = g.Key, Count = g.Count() })
            .OrderByDescending(g => g.Count)
            .ToList();

        // Sadece en çok kullanılan 5 para birimini göster, diğerlerini "Diğer" olarak grupla
        var topCurrencies = currencyGroups.Take(5).ToList();
        var otherCount = currencyGroups.Skip(5).Sum(g => g.Count);

        var data = new List<double>();
        var labels = new List<string>();

        // Top currencies'leri ekle
        foreach (var currencyGroup in topCurrencies)
        {
            data.Add(currencyGroup.Count);
            labels.Add(currencyGroup.CurrencyType.GetDisplayName());
        }

        // Diğerlerini ekle (eğer varsa)
        if (otherCount > 0)
        {
            data.Add(otherCount);
            labels.Add("Diğer");
        }

        currencyDistributionData = data.ToArray();
        currencyLabels = labels.ToArray();

        StateHasChanged();
    }
    
    private async Task CalculateMonthlyTransactions(IEnumerable<Transaction> transactions)
    {
        // Son 6 ayın verilerini hazırla
        var now = DateTime.Now;
        var currentMonth = new DateTime(now.Year, now.Month, 1);
        var months = new List<DateTime>();
        
        // Son 6 ayı oluştur
        for (int i = 0; i < 6; i++)
        {
            months.Add(currentMonth.AddMonths(-i));
        }
        months.Reverse(); // Eski aydan yeni aya doğru sırala
        
        // TL, Altın ve Döviz için seriler oluştur
        var tlSeries = new double[6];
        var goldSeries = new double[6];
        var foreignCurrencySeries = new double[6];
        
        // Türkçe ay isimleri
        string[] turkishMonthNames = { "Ocak", "Şubat", "Mart", "Nisan", "Mayıs", "Haziran", "Temmuz", "Ağustos", "Eylül", "Ekim", "Kasım", "Aralık" };
        
        // Para birimine göre işlemleri aylara dağıt
        for (int i = 0; i < 6; i++)
        {
            var month = months[i];
            var nextMonth = month.AddMonths(1);
            
            var monthTransactions = transactions
                .Where(t => !t.IsDeleted && !t.IsDeposit && t.Date >= month && t.Date < nextMonth)
                .ToList();
            
            tlSeries[i] = monthTransactions.Count(t => t.CurrencyType == CurrencyType.TurkishLira);
            
            goldSeries[i] = monthTransactions.Count(t => 
                t.CurrencyType == CurrencyType.Gold14K || 
                t.CurrencyType == CurrencyType.Gold22K || 
                t.CurrencyType == CurrencyType.Gold24K || 
                t.CurrencyType == CurrencyType.QuarterGold || 
                t.CurrencyType == CurrencyType.HalfGold || 
                t.CurrencyType == CurrencyType.FullGold || 
                t.CurrencyType == CurrencyType.Ziynet);
                
            foreignCurrencySeries[i] = monthTransactions.Count(t => 
                t.CurrencyType == CurrencyType.Dollar || 
                t.CurrencyType == CurrencyType.Euro || 
                t.CurrencyType == CurrencyType.Sterlin || 
                t.CurrencyType == CurrencyType.Riyal);
        }
        
        // Grafik serilerini hazırla
        monthlyTransactionSeries = new List<ChartSeries>
        {
            new ChartSeries { Name = "TL", Data = tlSeries },
            new ChartSeries { Name = "Altın", Data = goldSeries },
            new ChartSeries { Name = "Döviz", Data = foreignCurrencySeries }
        };
        
        // Ay etiketlerini hazırla
        var customMonthLabels = new List<string>();
        foreach (var month in months)
        {
            customMonthLabels.Add($"{turkishMonthNames[month.Month - 1]} {month.Year}");
        }
        monthLabels = customMonthLabels.ToArray();
    }
    
    private async Task CalculateTopCustomers(IEnumerable<Transaction> transactions)
    {
        // Müşterilere göre işlem sayılarını grupla
        var customerGroups = transactions
            .Where(t => !t.IsDeleted && !t.IsDeposit && t.CustomerId > 0)
            .GroupBy(t => t.CustomerId)
            .Select(g => new CustomerActivityData { 
                CustomerId = g.Key, 
                TransactionCount = g.Count() 
            })
            .OrderByDescending(g => g.TransactionCount)
            .Take(5)
            .ToList();
        
        // Müşteri isimlerini ekle
        foreach (var customer in customerGroups)
        {
            var customerObj = await DatabaseService.GetCustomerAsync(customer.CustomerId);
            if (customerObj != null)
            {
                customer.CustomerName = customerObj.Name;
            }
            else
            {
                customer.CustomerName = "Bilinmeyen Müşteri";
            }
        }
        
        topCustomers = customerGroups;
    }
    
    private async Task CacheCustomerNames()
    {
        // Tüm müşterileri yükleyip önbelleğe al
        var customers = await DatabaseService.GetCustomersAsync();
        customerNames = customers.ToDictionary(c => c.Id, c => c.Name);
    }
    // Server-side pagination for customers
    private async Task<TableData<Customer>> ServerReloadCustomers(TableState state, CancellationToken cancellationToken)
    {
        try
        {

            var customers = await DatabaseService.GetCustomersPaginationAsync(state.Page, state.PageSize, state?.SortLabel, Helper.HelperMethods.GetSortDirection(state?.SortDirection), searchTerm);
            int totalItems = await DatabaseService.GetCustomerCountAsync(searchTerm);

            // Update balances for customers if necessary
            return new TableData<Customer>
            {
                Items = customers,
                TotalItems = totalItems
            };
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex);
            // Handle errors
            return new TableData<Customer>
            {
                Items = new List<Customer>(),
                TotalItems = 0
            };
        }
    }

    private async Task OnCustomerSearch(string text)
    {
        searchTerm = text;
        await customerTable.ReloadServerData();
    }

    // QuickEntry methods
    private async Task LoadQuickEntries()
    {
        isLoadingQuickEntries = true;
        try
        {
            quickEntries = await DatabaseService.GetQuickEntriesAsync();
        }
        finally
        {
            isLoadingQuickEntries = false;
            StateHasChanged();
        }
    }

    private async Task SaveQuickEntryAsync()
    {
        if (currentQuickEntry.Id != 0)
        {
            // Düzenleme işlemi - CreatedDate'i koruyoruz
            var existingEntry = await DatabaseService.GetQuickEntryAsync(currentQuickEntry.Id);
            currentQuickEntry.CreatedDate = existingEntry.CreatedDate;
        }
        else
        {
            // Yeni kayıt - CreatedDate'i şu anki zaman olarak ayarlıyoruz
            currentQuickEntry.CreatedDate = DateTime.Now;
        }

        await DatabaseService.SaveQuickEntryAsync(currentQuickEntry);
        await LoadQuickEntries();

        // Form'u temizle
        ResetQuickEntryForm();
    }

    private void ResetQuickEntryForm()
    {
        currentQuickEntry = new QuickEntry
            {
                Id = 0
            };
    }

    private async Task DeleteQuickEntryAsync(QuickEntry entry)
    {
        bool? result = await DialogService.ShowMessageBox(
            "Silme Onayı",
            "Bu kaydı silmek istediğinize emin misiniz?",
            yesText: "Evet", cancelText: "Hayır");

        if (result == true)
        {
            await DatabaseService.DeleteQuickEntryAsync(entry);
            await LoadQuickEntries();
        }
    }

    private async Task EditQuickEntry(QuickEntry entry)
    {
        // Düzenlenecek kaydın bilgilerini forma yükle
        currentQuickEntry = new QuickEntry
            {
                Id = entry.Id,
                FullName = entry.FullName,
                TcKimlikNo = entry.TcKimlikNo,
                Tutar = entry.Tutar,
                IsProcessed = entry.IsProcessed,
                CreatedDate = entry.CreatedDate
            };

        // Formun bulunduğu konuma kaydır
        await JSRuntime.InvokeVoidAsync("scrollToTop");
    }

    private async Task UpdateProcessedStatus(QuickEntry entry, bool value)
    {
        entry.IsProcessed = value;
        await DatabaseService.UpdateQuickEntryAsync(entry);
    }

    // Customer methods
    private async Task LoadCustomers()
    {
        isLoadingCustomers = true;
        
        
        // Sayfalama kullanıldığı için müşteri listesinin 
        // tamamını burada yüklemeye gerek yok, 
        // sadece customerTable.ReloadServerData() çağırıyoruz
        if (customerTable != null)
        {
            await customerTable.ReloadServerData();
        }
        
        isLoadingCustomers = false;
    }

    private void Search()
    {
        // Legacy method, server-side filtering ile değişti
        if (customerTable != null)
        {
            customerTable.ReloadServerData();
        }
    }


    private void ShowCustomerModal(Customer customer)
    {
        currentCustomer = new Customer
            {
                Id = customer.Id,
                Name = customer.Name,
                PhoneNumber = customer.PhoneNumber
            };
        showCustomerModal = true;
    }

    private void CloseCustomerModal()
    {
        showCustomerModal = false;
    }

    private async Task SaveCustomer()
    {
        // Yeni müşteri ekliyorsak aynı isimde başka müşteri var mı kontrol et
        if (currentCustomer.Id == 0 && !string.IsNullOrWhiteSpace(currentCustomer.Name))
        {
            var existingCustomer = await DatabaseService.GetCustomerByNameAsync(currentCustomer.Name);
            if (existingCustomer != null)
            {
                // Varolan müşteri bulundu, uyarı göster
                bool? result = await DialogService.ShowMessageBox(
                    "Aynı İsimde Müşteri Bulundu",
                    $"\"{currentCustomer.Name}\" adında bir müşteri zaten var. Ne yapmak istersiniz?",
                    yesText: "Varolan Müşteriye Git",
                    noText: "Yine de Kaydet",
                    cancelText: "İptal");

                if (result == true) // Varolan müşteriye git
                {
                    CloseCustomerModal();
                    NavigationManager.NavigateTo($"/customer/{existingCustomer.Id}");
                    return;
                }
                else if (result == null) // İptal
                {
                    return;
                }
                // Else: Yine de kaydet - devam et
            }
        }
        await DatabaseService.SaveCustomerAsync(currentCustomer);
        showCustomerModal = false;
        await LoadCustomers();
        NavigateToCustomerDetail(currentCustomer.Id);
    }

    private void EditCustomer(Customer customer)
    {
        currentCustomer = new Customer
            {
                Id = customer.Id,
                Name = customer.Name,
                PhoneNumber = customer.PhoneNumber
            };
        showCustomerModal = true;
    }

    private async Task DeleteCustomer(Customer customer)
    {
        bool? result = await DialogService.ShowMessageBox(
            "Silme Onayı",
            $"{customer.Name} isimli müşteriyi silmek istediğinize emin misiniz?",
            yesText: "Evet", cancelText: "Hayır");

        if (result == true)
        {
            await DatabaseService.DeleteCustomerAsync(customer);
            await LoadCustomers();
        }
    }

    private void NavigateToCustomerDetail(int customerId)
    {
        NavigationManager.NavigateTo($"/customer/{customerId}");
    }

    private async Task LoadTransactions()
    {
        isLoadingTransactions = true;
        transactions = await DatabaseService.GetTransactionsAsync();
        transactions = transactions.Where(t => !t.IsDeposit).ToList();
        isLoadingTransactions = false;
    }

    private async Task<TableData<Transaction>> ServerReloadTransactions(TableState state, CancellationToken cancellationToken)
    {
        try
        {
            var transactions = await DatabaseService.GetTransactionsPaginationAsync(state.Page, state.PageSize, state?.SortLabel, Helper.HelperMethods.GetSortDirection(state?.SortDirection), transactionSearchTerm);
            transactions = transactions.Where(t => !t.IsDeposit).ToList();
            int totalItems = await DatabaseService.GetTransactionCountAsync(transactionSearchTerm);

            // Müşteri adlarını yükleyelim
            foreach (var transaction in transactions)
            {
                if (transaction.CustomerId > 0 && !transactionCustomerNames.ContainsKey(transaction.CustomerId))
                {
                    var customer = await DatabaseService.GetCustomerAsync(transaction.CustomerId);
                    if (customer != null)
                    {
                        transactionCustomerNames[transaction.CustomerId] = customer.Name;
                    }
                }
            }

            return new TableData<Transaction>
            {
                Items = transactions,
                TotalItems = totalItems
            };
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex);
            // Handle errors
            return new TableData<Transaction>
            {
                Items = new List<Transaction>(),
                TotalItems = 0
            };
        }
    }

    private async Task OnTransactionSearch(string text)
    {
        transactionSearchTerm = text;
        await transactionTable.ReloadServerData();
    }


    private string GetCustomerName(int customerId)
    {
        // Önce customerNames sözlüğünde var mı diye kontrol edelim
        if (customerNames.ContainsKey(customerId))
        {
            return customerNames[customerId];
        }
        
        return "Bilinmeyen Müşteri";
    }

    private string GetCurrencyName(CurrencyType currencyType)
    {
        return currencyType.GetDisplayName();
    }

    private decimal GetProcessedTotalAmount()
    {
        return quickEntries?.Where(e => e.IsProcessed).Sum(e => e.Tutar) ?? 0;
    }

    private decimal GetUnprocessedTotalAmount()
    {
        return quickEntries?.Where(e => !e.IsProcessed).Sum(e => e.Tutar) ?? 0;
    }

    private decimal GetTotalAmount()
    {
        return quickEntries?.Sum(e => e.Tutar) ?? 0;
    }

    private async Task CalculateIndebtedCustomers(IEnumerable<Transaction> transactions)
    {
        // Borçlu müşteri sayısını servis üzerinden hesapla
        indebtedCustomersCount = await DatabaseService.GetIndebtedCustomersCountAsync();
    }
    
    private async Task BackupToGoogleDrive()
    {
        try
        {
            isBackupInProgress = true;
            StateHasChanged();

            backupResult = await GoogleDriveService.BackupDatabaseAsync();

            await DialogService.ShowMessageBox(
                "Yedekleme",
                backupResult,
                yesText: "Tamam");
        }
        catch (Exception ex)
        {
            await DialogService.ShowMessageBox(
                "Hata",
                $"Yedekleme sırasında bir hata oluştu: {ex.Message}",
                yesText: "Tamam");
        }
        finally
        {
            isBackupInProgress = false;
            StateHasChanged();
        }
    }
    

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JSRuntime.InvokeVoidAsync("eval", @"
                window.scrollToTop = function() {
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            ");
        }
    }
}
