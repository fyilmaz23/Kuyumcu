@page "/transactions"
@inject DatabaseService DatabaseService
@inject NavigationManager NavigationManager

<MudContainer Class="mt-4">
    <MudPaper Elevation="0" Class="mb-4">
        <MudGrid>
            <MudItem xs="12">
                <MudText Typo="Typo.h4">Tüm İşlemler</MudText>
            </MudItem>
        </MudGrid>
    </MudPaper>

    <MudPaper Elevation="1" Class="pa-4 mb-4">
        <MudGrid>
            <MudItem xs="12" sm="4">
                    <MudSelect T="TransactionType?" Label="İşlem Türü" @bind-Value="filterType" Variant="Variant.Outlined">
                                <MudSelectItem T="TransactionType?" Value="@((TransactionType?)null)">Tümü</MudSelectItem>
                                <MudSelectItem T="TransactionType?" Value="@(TransactionType.CustomerDebt)">Sadece Müşteri Borçları</MudSelectItem>
                                <MudSelectItem T="TransactionType?" Value="@(TransactionType.StoreDebt)">Sadece Kuyumcu Borçları</MudSelectItem>
                            </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="8" Class="d-flex justify-end">
                <MudButton Variant="Variant.Outlined" Color="Color.Secondary" StartIcon="@Icons.Material.Filled.ArrowBack" 
                          OnClick="@(() => NavigationManager.NavigateTo("/"))">
                    Ana Sayfa
                </MudButton>
            </MudItem>
        </MudGrid>
    </MudPaper>

    @if (isLoading)
    {
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" Class="my-7" Size="Size.Large" />
    }
    else
    {
        <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-6">
            <MudTabPanel Text="Tüm İşlemler">
                @if (transactions == null || transactions.Count == 0)
                {
                    <MudAlert Severity="Severity.Info" Class="ma-4">Henüz işlem kaydı bulunmamaktadır.</MudAlert>
                }
                else if (filteredTransactions.Count == 0)
                {
                    <MudAlert Severity="Severity.Info" Class="ma-4">Seçilen kriterlere uygun işlem bulunamadı.</MudAlert>
                }
                else
                {
                    <MudTable Items="@filteredTransactions" Hover="true" Breakpoint="Breakpoint.Sm" Loading="@isLoading" 
                            LoadingProgressColor="Color.Primary">
                        <HeaderContent>
                            <MudTh>Tarih</MudTh>
                            <MudTh>Müşteri</MudTh>
                            <MudTh>Tür</MudTh>
                            <MudTh>Tutar</MudTh>
                            <MudTh>Para/Değer</MudTh>
                            <MudTh>Açıklama</MudTh>
                            <MudTh>İşlemler</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd DataLabel="Tarih">@context.Date.ToString("dd.MM.yyyy HH:mm")</MudTd>
                            <MudTd DataLabel="Müşteri">
                                @if (customerNames.ContainsKey(context.CustomerId))
                                {
                                    <MudLink Href="@($"/customer/{context.CustomerId}")">@customerNames[context.CustomerId]</MudLink>
                                }
                                else
                                {
                                    <MudText>Bilinmeyen Müşteri</MudText>
                                }
                            </MudTd>
                            <MudTd DataLabel="Tür">
                                @if (context.Type == TransactionType.CustomerDebt)
                                {
                                    <MudChip T="string" Color="Color.Error" Size="Size.Small">Giden</MudChip>
                                }
                                else
                                {
                                    <MudChip T="string" Color="Color.Success" Size="Size.Small" >Gelen</MudChip>
                                }
                            </MudTd>
                            <MudTd DataLabel="Tutar">@context.Amount.ToString("N2")</MudTd>
                            <MudTd DataLabel="Para/Değer">@context.CurrencyType.GetDisplayName() (@context.CurrencyType.GetSymbol())</MudTd>
                            <MudTd DataLabel="Açıklama">@(context.Description ?? "-")</MudTd>
                            <MudTd DataLabel="İşlemler">
                                <MudIconButton Icon="@Icons.Material.Filled.Visibility" Color="Color.Info" Size="Size.Small"
                                            OnClick="@(() => ViewTransactionDetails(context))" />
                            </MudTd>
                        </RowTemplate>
                    </MudTable>
                    
                    <MudPaper Elevation="2" Class="mt-4 pa-4">
                        <MudText Typo="Typo.h6" Class="mb-3">Özet</MudText>
                        
                        @foreach (var currencyType in Enum.GetValues<CurrencyType>())
                        {
                            @if (currencySummaries.ContainsKey(currencyType) && 
                                 (currencySummaries[currencyType].TotalCustomerDebt > 0 || currencySummaries[currencyType].TotalStoreDebt > 0))
                            {
                                <MudText Typo="Typo.subtitle1" Class="mt-3 mb-2">
                                    <strong>@currencyType.GetDisplayName() (@currencyType.GetSymbol())</strong>
                                </MudText>
                                <MudGrid>
                                    <MudItem xs="12" sm="4">
                                        <MudPaper Elevation="0" Class="pa-3">
                                            <MudText Typo="Typo.subtitle1"><strong>Toplam Giden:</strong></MudText>
                                            <MudText Typo="Typo.h6" Color="Color.Error">
                                                @currencySummaries[currencyType].TotalCustomerDebt.ToString("N2") @currencyType.GetDisplayName()
                                            </MudText>
                                        </MudPaper>
                                    </MudItem>
                                    <MudItem xs="12" sm="4">
                                        <MudPaper Elevation="0" Class="pa-3">
                                            <MudText Typo="Typo.subtitle1"><strong>Toplam Gelen:</strong></MudText>
                                            <MudText Typo="Typo.h6" Color="Color.Success">
                                                @currencySummaries[currencyType].TotalStoreDebt.ToString("N2") @currencyType.GetDisplayName()
                                            </MudText>
                                        </MudPaper>
                                    </MudItem>
                                    <MudItem xs="12" sm="4">
                                        <MudPaper Elevation="0" Class="pa-3">
                                            <MudText Typo="Typo.subtitle1"><strong>Net Durum:</strong></MudText>
                                            @{
                                                decimal netBalance = currencySummaries[currencyType].TotalCustomerDebt - currencySummaries[currencyType].TotalStoreDebt;
                                            }
                                            @if (netBalance > 0)
                                            {
                                                <MudText Typo="Typo.h6" Color="Color.Error">
                                                    @netBalance.ToString("N2") @currencyType.GetDisplayName() (Giden)
                                                </MudText>
                                            }
                                            else if (netBalance < 0)
                                            {
                                                <MudText Typo="Typo.h6" Color="Color.Success">
                                                    @Math.Abs(netBalance).ToString("N2") @currencyType.GetDisplayName() (Gelen)
                                                </MudText>
                                            }
                                            else
                                            {
                                                <MudText Typo="Typo.h6">
                                                    0.00 @currencyType.GetDisplayName() (Eşit)
                                                </MudText>
                                            }
                                        </MudPaper>
                                    </MudItem>
                                </MudGrid>
                                <MudDivider Class="my-3" />
                            }
                        }
                    </MudPaper>
                }
            </MudTabPanel>
            <MudTabPanel Text="Uzun Süreli Borçlar">
                @if (isLoading)
                {
                    <MudProgressCircular Color="Color.Primary" Indeterminate="true" Class="my-7" Size="Size.Large" />
                }
                else if (customersWithLongDebt == null || customersWithLongDebt.Count == 0)
                {
                    <MudAlert Severity="Severity.Info" Class="ma-4">Borçlu müşteri bulunmamaktadır.</MudAlert>
                }
                else
                {
                    <MudTable Items="@customersWithLongDebt" Hover="true" Breakpoint="Breakpoint.Sm">
                        <HeaderContent>
                            <MudTh>Müşteri</MudTh>
                            <MudTh>Borç Başlangıç Tarihi</MudTh>
                            <MudTh>Borç Süresi</MudTh>
                            <MudTh>Bakiye (TL)</MudTh>
                            <MudTh>İşlemler</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd DataLabel="Müşteri">
                                <MudLink Href="@($"/customer/{context.CustomerId}")">@context.CustomerName</MudLink>
                            </MudTd>
                            <MudTd DataLabel="Borç Başlangıç Tarihi">@context.EarliestDebtDate.ToString("dd.MM.yyyy HH:mm")</MudTd>
                            <MudTd DataLabel="Borç Süresi">@GetDebtDurationText(context.EarliestDebtDate)</MudTd>
                            <MudTd DataLabel="Bakiye (TL)">
                                <MudText Color="Color.Error">@context.Balance.ToString("C2") TL</MudText>
                            </MudTd>
                            <MudTd DataLabel="İşlemler">
                                <MudIconButton Icon="@Icons.Material.Filled.Visibility" Color="Color.Info" Size="Size.Small"
                                            OnClick="@(() => ViewCustomerDetails(context.CustomerId))" />
                            </MudTd>
                        </RowTemplate>
                    </MudTable>
                }
            </MudTabPanel>
        </MudTabs>
    }
</MudContainer>

@code {
    private List<Transaction> transactions;
    private Dictionary<int, string> customerNames = new Dictionary<int, string>();
    private bool isLoading = true;
    private TransactionType? filterType = null; 

    private Dictionary<CurrencyType, CurrencySummary> currencySummaries = new Dictionary<CurrencyType, CurrencySummary>();
    
    private List<CustomerDebtInfo> customersWithLongDebt = new List<CustomerDebtInfo>();

    private List<Transaction> filteredTransactions => transactions?
        .Where(t => filterType == null || t.Type == filterType)
        .OrderBy(t => t.Date)
        .ToList();

    protected override async Task OnInitializedAsync()
    {
        isLoading = true;
        transactions = await DatabaseService.GetTransactionsAsync();
        
        var customers = await DatabaseService.GetCustomersAsync();
        foreach (var customer in customers)
        {
            customerNames[customer.Id] = customer.Name;
        }
        
        CalculateTotals();
        await CalculateCustomersWithLongDebt();
        
        isLoading = false;
    }
    
    private async Task CalculateCustomersWithLongDebt()
    {
        var customers = await DatabaseService.GetCustomersAsync();
        customersWithLongDebt.Clear();
        
        foreach (var customer in customers)
        {
            var customerTransactions = transactions.Where(t => t.CustomerId == customer.Id && t.CurrencyType == CurrencyType.TurkishLira).ToList();
            
            if (customerTransactions.Count > 0)
            {
                decimal customerBalance = 0;
                DateTime earliestDebtDate = DateTime.MaxValue;
                
                foreach (var transaction in customerTransactions.OrderBy(t => t.Date))
                {
                    if (transaction.Type == TransactionType.CustomerDebt)
                    {
                        customerBalance += transaction.Amount;
                        if (customerBalance > 0 && earliestDebtDate == DateTime.MaxValue)
                        {
                            earliestDebtDate = transaction.Date;
                        }
                    }
                    else
                    {
                        customerBalance -= transaction.Amount;
                        if (customerBalance <= 0)
                        {
                            earliestDebtDate = DateTime.MaxValue;
                        }
                    }
                }
                
                if (customerBalance > 0 && 
                    earliestDebtDate != DateTime.MaxValue && 
                    (DateTime.Now - earliestDebtDate).TotalDays >= 30)
                {
                    customersWithLongDebt.Add(new CustomerDebtInfo
                    {
                        CustomerId = customer.Id,
                        CustomerName = customer.Name,
                        Balance = customerBalance,
                        EarliestDebtDate = earliestDebtDate
                    });
                }
            }
        }
        
        customersWithLongDebt = customersWithLongDebt
            .OrderBy(c => c.EarliestDebtDate)
            .ToList();
    }
    
    private void CalculateTotals()
    {
        currencySummaries.Clear();
        foreach (var currencyType in Enum.GetValues<CurrencyType>())
        {
            currencySummaries[currencyType] = new CurrencySummary();
        }
        
        if (transactions != null)
        {
            foreach (var transaction in transactions)
            {
                if (transaction.Type == TransactionType.CustomerDebt)
                {
                    currencySummaries[transaction.CurrencyType].TotalCustomerDebt += transaction.Amount;
                }
                else
                {
                    currencySummaries[transaction.CurrencyType].TotalStoreDebt += transaction.Amount;
                }
            }
        }
    }

    private void ViewTransactionDetails(Transaction transaction)
    {
        NavigationManager.NavigateTo($"/customer/{transaction.CustomerId}");
    }
    
    private void ViewCustomerDetails(int customerId)
    {
        NavigationManager.NavigateTo($"/customer/{customerId}");
    }
    
    private string GetDebtDurationText(DateTime debtDate)
    {
        TimeSpan duration = DateTime.Now - debtDate;
        
        if (duration.TotalDays >= 365)
        {
            int years = (int)(duration.TotalDays / 365);
            return $"{years} yıl, {(int)((duration.TotalDays % 365) / 30)} ay";
        }
        else if (duration.TotalDays >= 30)
        {
            int months = (int)(duration.TotalDays / 30);
            return $"{months} ay, {(int)(duration.TotalDays % 30)} gün";
        }
        else
        {
            return $"{(int)duration.TotalDays} gün";
        }
    }
    
    private class CustomerDebtInfo
    {
        public int CustomerId { get; set; }
        public string CustomerName { get; set; }
        public decimal Balance { get; set; }
        public DateTime EarliestDebtDate { get; set; }
    }
    
    private class CurrencySummary
    {
        public decimal TotalCustomerDebt { get; set; } = 0;
        public decimal TotalStoreDebt { get; set; } = 0;
    }
}
